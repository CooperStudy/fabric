/*
Copyright IBM Corp. 2017 All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

		 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

package channel

import (
	"context"
	"errors"
	"fmt"
	"github.com/hyperledger/fabric/protos/msp"
	"io/ioutil"
	"github.com/golang/protobuf/proto"
	"github.com/hyperledger/fabric/core/scc/cscc"
	"github.com/hyperledger/fabric/peer/common"
	pcommon "github.com/hyperledger/fabric/protos/common"
	pb "github.com/hyperledger/fabric/protos/peer"
	putils "github.com/hyperledger/fabric/protos/utils"
	"github.com/spf13/cobra"
)

const commandDescription = "Joins the peer to a channel."

func joinCmd(cf *ChannelCmdFactory) *cobra.Command {
	// Set the flags on the channel start command.
	joinCmd := &cobra.Command{
		Use:   "join",
		Short: commandDescription,
		Long:  commandDescription,
		RunE: func(cmd *cobra.Command, args []string) error {
			return join(cmd, args, cf)
		},
	}
	flagList := []string{
		"blockpath",
	}
	attachFlags(joinCmd, flagList)

	return joinCmd
}

//GBFileNotFoundErr genesis block file not found
type GBFileNotFoundErr string

func (e GBFileNotFoundErr) Error() string {
	logger.Info("=====GBFileNotFoundErr====Error=======")
	return fmt.Sprintf("genesis block file not found %s", string(e))
}

//ProposalFailedErr proposal failed
type ProposalFailedErr string

func (e ProposalFailedErr) Error() string {
	logger.Info("=====ProposalFailedErr====Error=======")
	return fmt.Sprintf("proposal failed (err: %s)", string(e))
}

func getJoinCCSpec() (*pb.ChaincodeSpec, error) {
	logger.Info("====getJoinCCSpec======")
	/*
	genesisBlockPath 是 peer join -b的参数
	 */
	if genesisBlockPath == common.UndefinedParamValue {
		return nil, errors.New("Must supply genesis block file")
	}
	//logger.Info("===========genesisBlockPath=======",genesisBlockPath)//mychannel.block
	gb, err := ioutil.ReadFile(genesisBlockPath)
	if err != nil {
		return nil, GBFileNotFoundErr(err.Error())
	}
	// Build the spec
	input := &pb.ChaincodeInput{Args: [][]byte{[]byte(cscc.JoinChain), gb}}

	spec := &pb.ChaincodeSpec{
		Type:        pb.ChaincodeSpec_Type(pb.ChaincodeSpec_Type_value["GOLANG"]),
		ChaincodeId: &pb.ChaincodeID{Name: "cscc"},
		Input:       input,
	}

	return spec, nil
}

func executeJoin(cf *ChannelCmdFactory) (err error) {
	logger.Info("====func executeJoin(cf *ChannelCmdFactory) (err error)======")
	spec, err := getJoinCCSpec()
	if err != nil {
		return err
	}

	// Build the ChaincodeInvocationSpec message
	invocation := &pb.ChaincodeInvocationSpec{ChaincodeSpec: spec}


	creator, err := cf.Signer.Serialize()
	/*

	==func (id *identity) Serialize() ([]byte, error)=
	 */

	cc := &msp.SerializedIdentity{}
	err = proto.Unmarshal(creator,cc)
	logger.Infof("============获取创建者.Name:%v==========",cc.Mspid)//Org1MSP
	//logger.Infof("==========executeJoin creator, err:%v := cf.Signer.Serialize()===================",err)

	if err != nil {
		return fmt.Errorf("Error serializing identity for %s: %s", cf.Signer.GetIdentifier(), err)
	}

	var prop *pb.Proposal
	prop, _, err = putils.CreateProposalFromCIS(pcommon.HeaderType_CONFIG, "", invocation, creator)
	if err != nil {
		return fmt.Errorf("Error creating proposal for join %s", err)
	}

	var signedProp *pb.SignedProposal
	signedProp, err = putils.GetSignedProposal(prop, cf.Signer)
	if err != nil {
		return fmt.Errorf("Error creating signed proposal %s", err)
	}


	var proposalResp *pb.ProposalResponse
	//logger.Infof("=============发送请求signedProp到peer节点:%v===============",signedProp)
	/*
	jion block
	proposal_bytes:"\n\264\007\n\\\010\001\032\014\010\311\347\226\215\006\020\251\356\355\222\001*@45869a738cb8f78f35370d4eaf4b19c045e3570225550430f6b1438690d3569b:\010\022\006\022\004cscc\022\323\006\n\266\006\n\007Org1MSP\022\252\006-----BEGIN CERTIFICATE-----\nMIICKjCCAdGgAwIBAgIRAMjEhftJ+J2t1B2nJ+3chQQwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBsMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEPMA0GA1UECxMGY2xpZW50MR8wHQYDVQQDDBZBZG1pbkBv\ncmcxLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEG+vL+0Hg\nn9RjkjRW6LxLvjeUq4GIc9w9S4sLnZyY+aapIsSaC63QnKHc+61kOhG/SDT+W9/s\nMdA6DdKjmN0Wz6NNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYD\nVR0jBCQwIoAgAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZI\nzj0EAwIDRwAwRAIgBmqNtMvFFvkM9YhsrONuHbHoRI3zwhgvLMv7YQ6PAHgCICnV\n2cULDo7xjVuw3OvDcMV6uZ3HPwBK1vU3rQwfWq8i\n-----END CERTIFICATE-----\n\022\030\302\341\330c\344\333\322C\306\226\226{\350\306 \304\271\341\245\266N\371\324\210\022\203}\n\200}\n\375|\010\001\022\006\022\004cscc\032\360|\n\tJoinChain\n\342|\n\"\032 \376\014\262\024k\343\034\")\340\334[\316\237\3102\021\251e\000\210\255\236N1\247\212\304\377\022(\265\022\261|\n\256|\n\343{\n\307\006\n\025\010\001\032\006\010\214\334\226\215\006\"\tmychannel\022\255\006\n\220\006\n\nOrdererMSP\022\201\006-----BEGIN CERTIFICATE-----\nMIICCzCCAbKgAwIBAgIQND386RJEAhUsur3ktYAsjTAKBggqhkjOPQQDAjBpMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEUMBIGA1UEChMLZXhhbXBsZS5jb20xFzAVBgNVBAMTDmNhLmV4YW1w\nbGUuY29tMB4XDTIxMTEzMDAzMTUwMFoXDTMxMTEyODAzMTUwMFowWDELMAkGA1UE\nBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBGcmFuY2lz\nY28xHDAaBgNVBAMTE29yZGVyZXIuZXhhbXBsZS5jb20wWTATBgcqhkjOPQIBBggq\nhkjOPQMBBwNCAAQKa6cycWU6D8nNIskwcaFfWcWa5LujjwW+eILlAjzsBxUGw5fY\nFkxBsAH4Hmyp6zub6wY1ISxz9kvvJRSRBr+Jo00wSzAOBgNVHQ8BAf8EBAMCB4Aw\nDAYDVR0TAQH/BAIwADArBgNVHSMEJDAigCAHP1j87mv7im4VhAzisbd0UZWhKn4/\nn25Gbtzf/8HbYDAKBggqhkjOPQQDAgNHADBEAiAMutk2CEEIG/dg75jhcemYufeA\neAaSY9Lf65Wfv04dOQIgW6Pqjbvkl7hBYrlw6M3kOM5fEuMkLl1tUz2zamboBiU=\n-----END CERTIFICATE-----\n\022\030\3374^6\214]\370\001\322K\006\022\207B\270\201\224GB\231\273i+\037\022\226u\n\365c\010\001\022\360c\022\344\027\n\007Orderer\022\330\027\022\207\025\n\nOrdererOrg\022\370\024\032\315\023\n\003MSP\022\305\023\022\272\023\022\267\023\n\nOrdererMSP\022\302\006-----BEGIN CERTIFICATE-----\nMIICPDCCAeOgAwIBAgIQAb1+yspwS6Xc9IS8RhYaLzAKBggqhkjOPQQDAjBpMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEUMBIGA1UEChMLZXhhbXBsZS5jb20xFzAVBgNVBAMTDmNhLmV4YW1w\nbGUuY29tMB4XDTIxMTEzMDAzMTUwMFoXDTMxMTEyODAzMTUwMFowaTELMAkGA1UE\nBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBGcmFuY2lz\nY28xFDASBgNVBAoTC2V4YW1wbGUuY29tMRcwFQYDVQQDEw5jYS5leGFtcGxlLmNv\nbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABDkcEEzsHGAO+uy1ryNvVgAKR9AQ\nanqfg+eRUtaE/DDw/2h4WjMSUovVxm8wJCNY/W+nrU0zpLeXPHTsA4GtoD+jbTBr\nMA4GA1UdDwEB/wQEAwIBpjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEw\nDwYDVR0TAQH/BAUwAwEB/zApBgNVHQ4EIgQgBz9Y/O5r+4puFYQM4rG3dFGVoSp+\nP59uRm7c3//B22AwCgYIKoZIzj0EAwIDRwAwRAIgeMJaX2eNxmjXG7yAN1ZHcFrP\nUB+ifY15alimi1p1NOgCIBYBgjEsy9XIkHQ67X3fY0uUTIa2cC+ZRynN2h9OZ0Gr\n-----END CERTIFICATE-----\n\"\201\006-----BEGIN CERTIFICATE-----\nMIICCzCCAbGgAwIBAgIRALOwUHJ94x3z7p02b7Gu0aowCgYIKoZIzj0EAwIwaTEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xFDASBgNVBAoTC2V4YW1wbGUuY29tMRcwFQYDVQQDEw5jYS5leGFt\ncGxlLmNvbTAeFw0yMTExMzAwMzE1MDBaFw0zMTExMjgwMzE1MDBaMFYxCzAJBgNV\nBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1TYW4gRnJhbmNp\nc2NvMRowGAYDVQQDDBFBZG1pbkBleGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqG\nSM49AwEHA0IABFMEHopR2utxnDsqqTwDwK6O7CZvKisWL0sDvCUlaCop3/EYIUIW\nXrnLbnWB36Wr9TVAslaOF3L2mBuTuLfAVv+jTTBLMA4GA1UdDwEB/wQEAwIHgDAM\nBgNVHRMBAf8EAjAAMCsGA1UdIwQkMCKAIAc/WPzua/uKbhWEDOKxt3RRlaEqfj+f\nbkZu3N//wdtgMAoGCCqGSM49BAMCA0gAMEUCIQDuuchmVgAe5WfgIXwTY6TWzfPw\n3Pj07f493Lni2rL2xwIgHXiqTqyoT2c/Sph3kHmMzXAZGlaA3KRMUZep+q7oYt0=\n-----END CERTIFICATE-----\nB\016\n\004SHA2\022\006SHA256J\317\006-----BEGIN CERTIFICATE-----\nMIICQzCCAemgAwIBAgIQBpwuZWA5C8ZX4y0FDR3IazAKBggqhkjOPQQDAjBsMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEUMBIGA1UEChMLZXhhbXBsZS5jb20xGjAYBgNVBAMTEXRsc2NhLmV4\nYW1wbGUuY29tMB4XDTIxMTEzMDAzMTUwMFoXDTMxMTEyODAzMTUwMFowbDELMAkG\nA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBGcmFu\nY2lzY28xFDASBgNVBAoTC2V4YW1wbGUuY29tMRowGAYDVQQDExF0bHNjYS5leGFt\ncGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABLFD8/yN+vhVxUkrS+8p\ntmJ5dyhIjfId6BWZgHrKzK2hWUIavRgfOeQh+TZgcyem5aCCxoVfWf8ghla47oJn\n5uyjbTBrMA4GA1UdDwEB/wQEAwIBpjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYB\nBQUHAwEwDwYDVR0TAQH/BAUwAwEB/zApBgNVHQ4EIgQgEiaoYeQQVBppa4FNFhKt\njQ8Hi4KbsnVfiEmLCsGNelAwCgYIKoZIzj0EAwIDSAAwRQIhAIs8rfJNdcSKHAZF\nUadWq+CaOO4EpuU12tPct47jWfOAAiBp4UJJSSOE3C2LlQHxF7BiIgZpaPUjX69j\nslHBOElQAw==\n-----END CERTIFICATE-----\n\032\006Admins\"3\n\007Writers\022(\022\036\010\001\022\032\022\010\022\006\010\001\022\002\010\000\032\016\022\014\n\nOrdererMSP\032\006Admins\"4\n\006Admins\022*\022 \010\001\022\034\022\010\022\006\010\001\022\002\010\000\032\020\022\016\n\nOrdererMSP\020\001\032\006Admins\"3\n\007Readers\022(\022\036\010\001\022\032\022\010\022\006\010\001\022\002\010\000\032\016\022\014\n\nOrdererMSP\032\006Admins*\006Admins\032$\n\014Capabilities\022\024\022\n\n\010\n\004V1_1\022\000\032\006Admins\032!\n\rConsensusType\022\020\022\006\n\004solo\032\006Admins\032\"\n\tBatchSize\022\025\022\013\010\n\020\200\200\3001\030\200\200 \032\006Admins\032\036\n\014BatchTimeout\022\016\022\004\n\0022s\032\006Admins\032\037\n\023ChannelRestrictions\022\010\032\006Admins\"*\n\017BlockValidation\022\027\022\r\010\003\022\t\n\007Writers\032\006Admins\"\"\n\007Readers\022\027\022\r\010\003\022\t\n\007Readers\032\006Admins\"\"\n\007Writers\022\027\022\r\010\003\022\t\n\007Writers\032\006Admins\"\"\n\006Admins\022\030\022\016\010\003\022\n\n\006Admins\020\002\032\006Admins*\006Admins\022\236I\n\013Application\022\216I\010\001\022\374#\n\007Org1MSP\022\360#\032\221\"\n\003MSP\022\211\"\022\376!\022\373!\n\007Org1MSP\022\343\006-----BEGIN CERTIFICATE-----\nMIICUjCCAfigAwIBAgIRAOeJ9r6+r5UjGqoSqwZRWhYwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBzMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UE\nAxMTY2Eub3JnMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IA\nBDmOXroUG9Zlpoa9MWpGmNCPLOpmiYc3x6j8kHIsxdQfY/NWG51F7lajre4CfUq3\nxw1UqGjvF67bRcTADd76QKejbTBrMA4GA1UdDwEB/wQEAwIBpjAdBgNVHSUEFjAU\nBggrBgEFBQcDAgYIKwYBBQUHAwEwDwYDVR0TAQH/BAUwAwEB/zApBgNVHQ4EIgQg\nAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZIzj0EAwIDSAAw\nRQIhAJX8iQGn7DPmVYWLHeXZgkdpws1b5xmgOKwPkPoBYw9oAiAsEHbBXlIzgqu3\n2CGVHsvyShuYxr5q5EwCvaWVFMRhlw==\n-----END CERTIFICATE-----\n\"\252\006-----BEGIN CERTIFICATE-----\nMIICKjCCAdGgAwIBAgIRAMjEhftJ+J2t1B2nJ+3chQQwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBsMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEPMA0GA1UECxMGY2xpZW50MR8wHQYDVQQDDBZBZG1pbkBv\ncmcxLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEG+vL+0Hg\nn9RjkjRW6LxLvjeUq4GIc9w9S4sLnZyY+aapIsSaC63QnKHc+61kOhG/SDT+W9/s\nMdA6DdKjmN0Wz6NNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYD\nVR0jBCQwIoAgAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZI\nzj0EAwIDRwAwRAIgBmqNtMvFFvkM9YhsrONuHbHoRI3zwhgvLMv7YQ6PAHgCICnV\n2cULDo7xjVuw3OvDcMV6uZ3HPwBK1vU3rQwfWq8i\n-----END CERTIFICATE-----\nB\016\n\004SHA2\022\006SHA256J\347\006-----BEGIN CERTIFICATE-----\nMIICVzCCAf6gAwIBAgIRANdNXXWuKyzK/Qdm2MJwAkkwCgYIKoZIzj0EAwIwdjEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHzAdBgNVBAMTFnRs\nc2NhLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMx\nNTAwWjB2MQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UE\nBxMNU2FuIEZyYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEfMB0G\nA1UEAxMWdGxzY2Eub3JnMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49\nAwEHA0IABNhRR7pIdZrJCALug9f/GDGMiHF4k52QLYAvWrzT664Ni391LzDo8lwp\n3zFQGvN2OpLtXejlWclyQBtL4wlnzvajbTBrMA4GA1UdDwEB/wQEAwIBpjAdBgNV\nHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDwYDVR0TAQH/BAUwAwEB/zApBgNV\nHQ4EIgQgh9d+T0TJr77x28LyS3uHbaB+0InwIeSk1PSJqhYJbOYwCgYIKoZIzj0E\nAwIDRwAwRAIgGmbVg1e9LZjYbInLvO+ytc/TLpGyr7SEvb1pdQifbIMCIFzZRcLO\n7uBh/XvaAMq5yoP2S6dSp0kCYlIv5mR/Bv2e\n-----END CERTIFICATE-----\nZ\342\r\010\001\022\356\006\n\343\006-----BEGIN CERTIFICATE-----\nMIICUjCCAfigAwIBAgIRAOeJ9r6+r5UjGqoSqwZRWhYwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBzMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UE\nAxMTY2Eub3JnMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IA\nBDmOXroUG9Zlpoa9MWpGmNCPLOpmiYc3x6j8kHIsxdQfY/NWG51F7lajre4CfUq3\nxw1UqGjvF67bRcTADd76QKejbTBrMA4GA1UdDwEB/wQEAwIBpjAdBgNVHSUEFjAU\nBggrBgEFBQcDAgYIKwYBBQUHAwEwDwYDVR0TAQH/BAUwAwEB/zApBgNVHQ4EIgQg\nAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZIzj0EAwIDSAAw\nRQIhAJX8iQGn7DPmVYWLHeXZgkdpws1b5xmgOKwPkPoBYw9oAiAsEHbBXlIzgqu3\n2CGVHsvyShuYxr5q5EwCvaWVFMRhlw==\n-----END CERTIFICATE-----\n\022\006client\032\354\006\n\343\006-----BEGIN CERTIFICATE-----\nMIICUjCCAfigAwIBAgIRAOeJ9r6+r5UjGqoSqwZRWhYwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBzMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UE\nAxMTY2Eub3JnMS5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IA\nBDmOXroUG9Zlpoa9MWpGmNCPLOpmiYc3x6j8kHIsxdQfY/NWG51F7lajre4CfUq3\nxw1UqGjvF67bRcTADd76QKejbTBrMA4GA1UdDwEB/wQEAwIBpjAdBgNVHSUEFjAU\nBggrBgEFBQcDAgYIKwYBBQUHAwEwDwYDVR0TAQH/BAUwAwEB/zApBgNVHQ4EIgQg\nAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZIzj0EAwIDSAAw\nRQIhAJX8iQGn7DPmVYWLHeXZgkdpws1b5xmgOKwPkPoBYw9oAiAsEHbBXlIzgqu3\n2CGVHsvyShuYxr5q5EwCvaWVFMRhlw==\n-----END CERTIFICATE-----\n\022\004peer\032\006Admins\"1\n\006Admins\022'\022\035\010\001\022\031\022\010\022\006\010\001\022\002\010\000\032\r\022\013\n\007Org1MSP\020\001\032\006Admins\"X\n\007Readers\022M\022C\010\001\022?\022\020\022\016\010\001\022\002\010\000\022\002\010\001\022\002\010\002\032\r\022\013\n\007Org1MSP\020\001\032\r\022\013\n\007Org1MSP\020\003\032\r\022\013\n\007Org1MSP\020\002\032\006Admins\"E\n\007Writers\022:\0220\010\001\022,\022\014\022\n\010\001\022\002\010\000\022\002\010\001\032\r\022\013\n\007Org1MSP\020\001\032\r\022\013\n\007Org1MSP\020\002\032\006Admins*\006Admins\022\360#\n\007Org2MSP\022\344#\032\205\"\n\003MSP\022\375!\022\362!\022\357!\n\007Org2MSP\022\337\006-----BEGIN CERTIFICATE-----\nMIICUDCCAfegAwIBAgIQPFQKsccECJsINGQT2kxvlDAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMTExMzAwMzE1MDBaFw0zMTExMjgwMzE1MDBa\nMHMxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBvcmcyLmV4YW1wbGUuY29tMRwwGgYDVQQD\nExNjYS5vcmcyLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE\nw1xsDYLQMO2mTFljo98IaqKTx0ujdDIpWYqbbc4ytbC/EmVDVzTLsMDLznUEojs0\nbAXRzMxws/yO6owfaxaPz6NtMGswDgYDVR0PAQH/BAQDAgGmMB0GA1UdJQQWMBQG\nCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MCkGA1UdDgQiBCAr\ni59RYVms0PsenfTYhK/rJ4xOcBlLLK8pRpUyNUs++TAKBggqhkjOPQQDAgNHADBE\nAiBiwnvrb19vD8bVXx4xXC1NkdU2MVpRyL728DY/TjNxuQIgdkEHvUPevcx6UDbr\nMJBS75wP0l4rZSsmNp8TNkUdbHY=\n-----END CERTIFICATE-----\n\"\252\006-----BEGIN CERTIFICATE-----\nMIICKjCCAdGgAwIBAgIRAIXhAanws8khrW/ErKrHTQwwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzIuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzIuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBsMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEPMA0GA1UECxMGY2xpZW50MR8wHQYDVQQDDBZBZG1pbkBv\ncmcyLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEht1UgSj2\n5RhyyPAvdrgsuRlXddtyl8P7TEC0nrKUyfnSQ7FzzrvBuMfDyHWoA20zCmpOiVme\ngaQVRxsj+jUBGqNNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYD\nVR0jBCQwIoAgK4ufUWFZrND7Hp302ISv6yeMTnAZSyyvKUaVMjVLPvkwCgYIKoZI\nzj0EAwIDRwAwRAIgSZ7YYVN8o0+UhEPgOd7QncbPN8keXievsDfKG6xwvCQCIGBD\nrusJSm/De1tFmwlb8sdU5MWRADOovJJ6TgF41VJ3\n-----END CERTIFICATE-----\nB\016\n\004SHA2\022\006SHA256J\347\006-----BEGIN CERTIFICATE-----\nMIICVzCCAf6gAwIBAgIRAP70scWxro3apA9T54w01ywwCgYIKoZIzj0EAwIwdjEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzIuZXhhbXBsZS5jb20xHzAdBgNVBAMTFnRs\nc2NhLm9yZzIuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMx\nNTAwWjB2MQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UE\nBxMNU2FuIEZyYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEfMB0G\nA1UEAxMWdGxzY2Eub3JnMi5leGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49\nAwEHA0IABDTiYlZBRlB6cMmV6W4JadtonFXp/hYbskFlKStOC7QV2nL9MpGcdeqg\nhhUBdnnpU7VZnjw7EWKrrRvK79nb0gyjbTBrMA4GA1UdDwEB/wQEAwIBpjAdBgNV\nHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDwYDVR0TAQH/BAUwAwEB/zApBgNV\nHQ4EIgQgn1MSdzv38inN6EYEoUODghBrFnzcP8/fu014BOP6j24wCgYIKoZIzj0E\nAwIDRwAwRAIgbUt5Ah/Eo0lqyAaqqnvSmMKnwGymLgA1Ab67qjymnLoCIEkYTzl6\nW4ETkeUAg5XGXZddSdFQJqENNuGxHbA9oblN\n-----END CERTIFICATE-----\nZ\332\r\010\001\022\352\006\n\337\006-----BEGIN CERTIFICATE-----\nMIICUDCCAfegAwIBAgIQPFQKsccECJsINGQT2kxvlDAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMTExMzAwMzE1MDBaFw0zMTExMjgwMzE1MDBa\nMHMxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBvcmcyLmV4YW1wbGUuY29tMRwwGgYDVQQD\nExNjYS5vcmcyLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE\nw1xsDYLQMO2mTFljo98IaqKTx0ujdDIpWYqbbc4ytbC/EmVDVzTLsMDLznUEojs0\nbAXRzMxws/yO6owfaxaPz6NtMGswDgYDVR0PAQH/BAQDAgGmMB0GA1UdJQQWMBQG\nCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MCkGA1UdDgQiBCAr\ni59RYVms0PsenfTYhK/rJ4xOcBlLLK8pRpUyNUs++TAKBggqhkjOPQQDAgNHADBE\nAiBiwnvrb19vD8bVXx4xXC1NkdU2MVpRyL728DY/TjNxuQIgdkEHvUPevcx6UDbr\nMJBS75wP0l4rZSsmNp8TNkUdbHY=\n-----END CERTIFICATE-----\n\022\006client\032\350\006\n\337\006-----BEGIN CERTIFICATE-----\nMIICUDCCAfegAwIBAgIQPFQKsccECJsINGQT2kxvlDAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMi5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMi5leGFtcGxlLmNvbTAeFw0yMTExMzAwMzE1MDBaFw0zMTExMjgwMzE1MDBa\nMHMxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBvcmcyLmV4YW1wbGUuY29tMRwwGgYDVQQD\nExNjYS5vcmcyLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE\nw1xsDYLQMO2mTFljo98IaqKTx0ujdDIpWYqbbc4ytbC/EmVDVzTLsMDLznUEojs0\nbAXRzMxws/yO6owfaxaPz6NtMGswDgYDVR0PAQH/BAQDAgGmMB0GA1UdJQQWMBQG\nCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MCkGA1UdDgQiBCAr\ni59RYVms0PsenfTYhK/rJ4xOcBlLLK8pRpUyNUs++TAKBggqhkjOPQQDAgNHADBE\nAiBiwnvrb19vD8bVXx4xXC1NkdU2MVpRyL728DY/TjNxuQIgdkEHvUPevcx6UDbr\nMJBS75wP0l4rZSsmNp8TNkUdbHY=\n-----END CERTIFICATE-----\n\022\004peer\032\006Admins\"X\n\007Readers\022M\022C\010\001\022?\022\020\022\016\010\001\022\002\010\000\022\002\010\001\022\002\010\002\032\r\022\013\n\007Org2MSP\020\001\032\r\022\013\n\007Org2MSP\020\003\032\r\022\013\n\007Org2MSP\020\002\032\006Admins\"E\n\007Writers\022:\0220\010\001\022,\022\014\022\n\010\001\022\002\010\000\022\002\010\001\032\r\022\013\n\007Org2MSP\020\001\032\r\022\013\n\007Org2MSP\020\002\032\006Admins\"1\n\006Admins\022'\022\035\010\001\022\031\022\010\022\006\010\001\022\002\010\000\032\r\022\013\n\007Org2MSP\020\001\032\006Admins*\006Admins\032$\n\014Capabilities\022\024\022\n\n\010\n\004V1_3\022\000\032\006Admins\"\"\n\007Readers\022\027\022\r\010\003\022\t\n\007Readers\032\006Admins\"\"\n\007Writers\022\027\022\r\010\003\022\t\n\007Writers\032\006Admins\"\"\n\006Admins\022\030\022\016\010\003\022\n\n\006Admins\020\002\032\006Admins*\006Admins\032*\n\nConsortium\022\034\022\022\n\020SampleConsortium\032\006Admins\032-\n\031BlockDataHashingStructure\022\020\022\006\010\377\377\377\377\017\032\006Admins\032I\n\020OrdererAddresses\0225\022\032\n\030orderer.example.com:7050\032\027/Channel/Orderer/Admins\032$\n\014Capabilities\022\024\022\n\n\010\n\004V1_3\022\000\032\006Admins\032&\n\020HashingAlgorithm\022\022\022\010\n\006SHA256\032\006Admins\"\"\n\006Admins\022\030\022\016\010\003\022\n\n\006Admins\020\002\032\006Admins\"\"\n\007Readers\022\027\022\r\010\003\022\t\n\007Readers\032\006Admins\"\"\n\007Writers\022\027\022\r\010\003\022\t\n\007Writers\032\006Admins*\006Admins\022\233\021\n\317\020\n\355\006\n\025\010\002\032\006\010\214\334\226\215\006\"\tmychannel\022\323\006\n\266\006\n\007Org1MSP\022\252\006-----BEGIN CERTIFICATE-----\nMIICKjCCAdGgAwIBAgIRAMjEhftJ+J2t1B2nJ+3chQQwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBsMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEPMA0GA1UECxMGY2xpZW50MR8wHQYDVQQDDBZBZG1pbkBv\ncmcxLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEG+vL+0Hg\nn9RjkjRW6LxLvjeUq4GIc9w9S4sLnZyY+aapIsSaC63QnKHc+61kOhG/SDT+W9/s\nMdA6DdKjmN0Wz6NNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYD\nVR0jBCQwIoAgAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZI\nzj0EAwIDRwAwRAIgBmqNtMvFFvkM9YhsrONuHbHoRI3zwhgvLMv7YQ6PAHgCICnV\n2cULDo7xjVuw3OvDcMV6uZ3HPwBK1vU3rQwfWq8i\n-----END CERTIFICATE-----\n\022\030\347\253\2369\302@\031\347\2774;\034\220\270\231\226\254:z\355\356?N\227\022\334\t\n\270\002\n\tmychannel\022;\022)\n\013Application\022\032\022\013\n\007Org1MSP\022\000\022\013\n\007Org2MSP\022\000\032\016\n\nConsortium\022\000\032\355\001\022\306\001\n\013Application\022\266\001\010\001\022\013\n\007Org1MSP\022\000\022\013\n\007Org2MSP\022\000\032$\n\014Capabilities\022\024\022\n\n\010\n\004V1_3\022\000\032\006Admins\"\"\n\007Writers\022\027\022\r\010\003\022\t\n\007Writers\032\006Admins\"\"\n\006Admins\022\030\022\016\010\003\022\n\n\006Admins\020\002\032\006Admins\"\"\n\007Readers\022\027\022\r\010\003\022\t\n\007Readers\032\006Admins*\006Admins\032\"\n\nConsortium\022\024\022\022\n\020SampleConsortium\022\236\007\n\323\006\n\266\006\n\007Org1MSP\022\252\006-----BEGIN CERTIFICATE-----\nMIICKjCCAdGgAwIBAgIRAMjEhftJ+J2t1B2nJ+3chQQwCgYIKoZIzj0EAwIwczEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20xHDAaBgNVBAMTE2Nh\nLm9yZzEuZXhhbXBsZS5jb20wHhcNMjExMTMwMDMxNTAwWhcNMzExMTI4MDMxNTAw\nWjBsMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMN\nU2FuIEZyYW5jaXNjbzEPMA0GA1UECxMGY2xpZW50MR8wHQYDVQQDDBZBZG1pbkBv\ncmcxLmV4YW1wbGUuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEG+vL+0Hg\nn9RjkjRW6LxLvjeUq4GIc9w9S4sLnZyY+aapIsSaC63QnKHc+61kOhG/SDT+W9/s\nMdA6DdKjmN0Wz6NNMEswDgYDVR0PAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYD\nVR0jBCQwIoAgAGRzGQYnOWgNLzd/m7ZeAzrW92x33P7GWLENTwXJSe4wCgYIKoZI\nzj0EAwIDRwAwRAIgBmqNtMvFFvkM9YhsrONuHbHoRI3zwhgvLMv7YQ6PAHgCICnV\n2cULDo7xjVuw3OvDcMV6uZ3HPwBK1vU3rQwfWq8i\n-----END CERTIFICATE-----\n\022\030\\RC\002\323D\346B5@NZ}#y\257X\366\334f\216\3012\031\022F0D\002 }\301\225\346\361E\213/\271\360r\033\314\273\311h\250\177\351l\355\260\244`j\313Z\215\r\210~\344\002 pb\232\016\213\255\034=\336\232\307\300i\302\241\346\356`\370\305\2667\253\345T\276\252\260D\022\240\336\022G0E\002!\000\230\361\264-z\312l\364e\036\253\276\200\364\250ta\344D\357\226\217\343lL\346\224\250\373\243g5\002 j\2448\254\270c\200\333o\002Q\253#\026\030\014\000kf\366i0u\272Z\023Lb>6f\344\022F0D\002 6.;\371\231v\3069\255\021\205\257\245\351\366\370\013\r\312wgX\226\256\236\342\003\267\374\214\241\371\002 5?\200`CM\232\320:\220\201\350\226\023\213\262W\211\r9V\014\312\306}\t\034@\333\235J$\032\010\n\000\n\000\n\000\n\000" signature:"0D\002 e\351y\306^_\026\266R\274?x\264k \341)\030\252`\0012\341D\202\315\215\360'\304wh\002 CfDr\217\r\263\375+\254U\243\3144\324\035;\37480:\310\267\177\205\207\356k$\260|\275"
	*/
	proposalResp, err = cf.EndorserClient.ProcessProposal(context.Background(), signedProp)
	if err != nil {
		return ProposalFailedErr(err.Error())
	}

	if proposalResp == nil {
		return ProposalFailedErr("nil proposal response")
	}

	if proposalResp.Response.Status != 0 && proposalResp.Response.Status != 200 {
		return ProposalFailedErr(fmt.Sprintf("bad proposal response %d: %s", proposalResp.Response.Status, proposalResp.Response.Message))
	}
	logger.Info("Successfully submitted proposal to join channel")
	return nil
}

func join(cmd *cobra.Command, args []string, cf *ChannelCmdFactory) error {
	logger.Info("====func join(cmd *cobra.Command, args []string, cf *ChannelCmdFactory) error======")
	if genesisBlockPath == common.UndefinedParamValue {
		return errors.New("Must supply genesis block path")
	}
	// Parsing of the command line is done so silence cmd usage
	cmd.SilenceUsage = true

	var err error
	if cf == nil {
		cf, err = InitCmdFactory(EndorserRequired, PeerDeliverNotRequired, OrdererNotRequired)
		if err != nil {
			return err
		}
	}
	return executeJoin(cf)
}
